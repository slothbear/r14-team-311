"use strict";angular.module("frontendApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","ui.router","restangular"]).config(["$stateProvider","$urlRouterProvider","$rootScopeProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/"}).state("welcome",{url:"/welcome",templateUrl:"views/welcome.html",controller:"WelcomeCtrl"}).state("dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"DashboardCtrl"})}]).config(["RestangularProvider","serverUrl",function(a,b){b.length>0&&a.setBaseUrl(b),a.setRestangularFields({id:"_id"}),a.setRequestInterceptor(function(a,b,c){"put"===b&&(a._id=void 0);var d;return("post"===b||"put"===b||"patch"===b)&&(d={},"s"===c[c.length-1]?d[c.substring(0,c.length-1)]=a:d=a),d}),a.setResponseExtractor(function(a,b){var c;return"getList"===b?(c=a.data,a.metadata&&(c.metadata=a.metadata)):c=a,c})}]),angular.module("frontendApp").controller("MainCtrl",["$scope","$rootScope","$state","$modal","$cookies","Restangular","notifications","Users",function(a,b,c,d,e,f,g,h){a.granularities=["monthly","weekly"],b.g="weekly",a.changeGranularity=function(a){b.g=a},a.$on("$stateChangeStart",function(a,d){h.fetchUser().then(function(){h.reloadStats(b.g),h.isEmpty()?"welcome"!==d.name&&c.transitionTo("welcome"):"dashboard"!==d.name&&c.transitionTo("dashboard")})}),g.checkPermissions(),f.one("sites","config").get().then(function(a){b.site_name=a.data.name})}]),angular.module("frontendApp").controller("StatsCtrl",["$scope","$rootScope","Restangular",function(a,b,c){function d(){return{assigned_issues:Math.round(20*Math.random()),closed_issues:Math.round(20*Math.random()),closed_pull_request:Math.round(20*Math.random()),commits:Math.round(20*Math.random()),opened_issues:Math.round(20*Math.random()),opened_pull_request:Math.round(20*Math.random()),opened_pull_requests:Math.round(20*Math.random()),points:Math.round(20*Math.random()),pushes:Math.round(20*Math.random()),collaborators:Math.round(20*Math.random())}}function e(){c.one("stats",b.g).getList().then(function(b){a.stats=b,a.current=a.stats[a.stats.length-1],f=a.stats[a.stats.length-2],a.stats.length<=1&&(f=d(),a.stats.unshift(f),a.stats.unshift(d()),a.stats.unshift(d()),a.stats.unshift(d()))})}var f;a.cStat="points",a.stats=[],b.$watch("g",function(){e()}),e(),a.extractData=function(b){for(var c=[],d=0;d<a.stats.length;d++){var e=a.stats[d];c.push(e[b]||0)}return c},a.getDelta=function(b){if(!a.current)return 0;var c=0;f&&(c=f[b]||0);var d=a.current[b]-c;return d=d>0?"+ "+d:"- "+Math.abs(d)};var g={assigned_issues:"assigned issues",closed_issues:"closed issues",closed_pull_request:"closed pull request",closed_pull_requests:"closed pull requests",commits:"commits",opened_issues:"opened issues",opened_pull_request:"opened pull request",opened_pull_requests:"opened pull requests",points:"points",pushes:"pushes",collaborators:"collaborators"};a.getLabel=function(a){return g[a]},a.changeCstat=function(b){a.cStat=b},a.isActive=function(b){return a.cStat===b}}]),angular.module("frontendApp").controller("RankingCtrl",["$scope","$rootScope","Restangular","Users",function(a,b,c,d){d.fetchUser().then(function(){d.reloadStats(b.q)}),a.stats=d.stats;var e={};c.one("achievements","types").getList().then(function(a){for(var b=0;b<a.length;b++){var c=a[b];e[c.id]={icon:c.image_url,label:c.name,description:c.description}}}),a.getAchievementIcon=function(a){return(e[a]||{}).icon},a.getAchievementLabel=function(a){return(e[a]||{}).label},a.getAchievementDescription=function(a){return(e[a]||{}).description},a.users=d.users(),b.$watch("g",function(a){d.reloadStats(a)}),a.fromNow=function(a){return moment(a).fromNow()}}]),angular.module("frontendApp").controller("LiveStreamCtrl",["$scope","$timeout","Restangular","notifications",function(a,b,c,d){var e=0,f={};c.one("achievements","types").getList().then(function(a){for(var b=0;b<a.length;b++){var c=a[b];f[c.id]=c.name}}),a.getAchievementName=function(a){return f[a]},a.getCommitterName=function(a){return a.committer.username||a.committer.email.replace(/@(.*)/,"")},function g(){c.all("events").getList({timestamp:e}).then(function(c){for(var f=0;f<c.length;f++){var h=c[f];if(h.created_at=moment(h.created_at),"push"===h.type){h.isCollapsed=!0;for(var i=[],j=[],k=0;k<h.data.commits.length;k++){var l=h.data.commits[k];l.timestamp=moment(l.timestamp),2>k?j.push(l):i.push(l)}h.data.more_commits=i,h.data.head_commits=j}a.events&&a.events.unshift(h)}if(c.length>0){var m=c[0];e=m.created_at.valueOf()/1e3,d.raise(m.user_data.login+" has a new event: "+m.type)}a.events||(a.events=c),b(g,1e4)})}()}]),angular.module("frontendApp").directive("sparkline",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.sparkline,function(c){a.statsData=c,b.sparkline(a.statsData,d)},!0);var d=b.data();d.type=d.type||"bar",d.disableHiddenCheck=!0,d.resize&&$(window).resize(function(){b.sparkline(a.statsData,d)})}}}),angular.module("frontendApp").controller("DashboardCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("frontendApp").factory("notifications",["$timeout",function(a){var b=Notification.permission;return{checkPermissions:function(){return"granted"!=b&&Notification.requestPermission(function(){console.log("Permission: ")}),b},raise:function(b){var c=new Notification("Gamegit",{body:b});a(function(){c.close()},3e3)}}}]),angular.module("frontendApp").factory("Users",["$q","Restangular",function(a,b){function c(a){for(var c=0;c<d.length;c++)b.one("user_stats",d[c].login).getList(a).then(function(a){e[a[0].login]=a[a.length-1]})}var d=[],e={};return{fetchUser:function(){var c=a.defer();return 0===d.length?b.all("users").getList().then(function(a){d=a,c.resolve(a)}):c.reject(),c.promise},isEmpty:function(){return 0===d.length},reloadStats:c,users:function(){return d},stats:function(a){return e[a]||{}}}}]),angular.module("frontendApp").controller("WelcomeCtrl",["$scope",function(){}]);